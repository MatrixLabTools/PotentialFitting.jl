# Overview of example use

This is an example workflow for doing the whole calculation, except calculating
potential itself that has been explained else where.

Molecular dynamics itself consist of 4 phases:
- Equilibration of initial geometry in gas phase
- Condensing gas to solid.
- Equilibration to DFT
- Spectrum calculation

# Fitting Potential

First we need to fit a potential. In this example we fit a potential for trans-formic acid
and argon. [PotentialDB](https://github.com/MatrixLabTools/PotentialDB.jl) has
pre calculated data than we can use for fitting the potential.

```@example md
using PotentialDB
r = defaultregistry()
data = loadpotential(r, "4")
```

The fitting procedure is the same as explained in [Usage](@ref) section.

First we create a potential for fitting.

```@example md
using PotentialFitting, PotentialCalculation

m1=MoleculeIdenticalInformation{AtomOnlySymbol}(data["cluster1"].atoms)
m2=MoleculeIdenticalInformation{AtomOnlySymbol}(data["cluster2"].atoms)

mpp = MoleculePairPotential(m1,m2, GeneralPowers(-6,-8,-10,-12,-7,-9,-11))
```

Then we prepare fitting data and apply some constrains. The reason why we applying
constrains is that our potential is under fitting and as a result depends
heavily on the constrains. You can verify this, by taking constrains off and
comparing to constrained potential, or by changing the constrains considerably.
```@example md
fdata = FitData(mpp, data["Points"], data["Energy"])

setweight_e_more!(fdata, 0.1, 1000)
setweight_e_more!(fdata, 0.01, 5000)
setweight_e_less!(fdata, 2, -50)
setweight_e_less!(fdata, 4, -75)
setweight_e_less!(fdata, 16, -100);

nothing # hide
```

Then we prepare fitting tools for fitting. Linear regression is most likely good
enough. But you can also try support vector machines or ridge regression etc.

```@example md
using ScikitLearn
@sk_import linear_model: LinearRegression

model = LinearRegression(fit_intercept=false)
```

Fitting potential.
```@example md
fit_potential!(model, mpp, fdata)
```

Check root mean square deviation for potential.
```@example md
rmsd(data["Points"], data["Energy"], mpp, emax=-10)
```
!!! note "Note"
    We are under fitting our potential, so we can safely compare the potential
    to the data we used for the fitting. But it would be a good idea to confirm this,
    by comparing to some data that was not used for fitting.


To inspect the potential we can use use `plot_compare` which will calculate
potential for given points. Here we visualize one line from potential.
```@example md
plot_compare(data["Points"][:,30], data["Energy"][:,30], mpp, leg=true)
```

`scan_compare`-command is also available and usually much faster to visualize
the fit.
```@example md
scan_compare(data["Points"], data["Energy"], mpp, leg=true)
```

If you found a place in the potential that is not well fitted and want to know
where it is, you can visualize it. There are two options
- `scan_visualize` Uses [Bio3DView](https://github.com/jgreener64/Bio3DView.jl) and needs IJulia (Jupyter notebook) or [Blink](https://github.com/JuliaGizmos/Blink.jl) to work.
- `visualize_points` This calls external program (defaults to VMD) for visualizations. Does not work with IJulia.

To call them use
```julia
scan_visualize(data["Points"])
```

```julia
# Visualize line 32 using vmd
visualize_points(data["Points"][:,32], command="vmd")
```

# Preparing CP2K input files

## Geometry inputs

First grab your favorite and make two file, one for the molecule/cluster you are
studying and one for matrix and save them in PDB-format. Here we have a file for
formic acid and an other for argon.

```
COMPND    UNNAMED
AUTHOR    GENERATED BY OPEN BABEL 2.3.2
HETATM    1  C   tfa     1      42.585  42.840  42.933  1.00  0.00           C
HETATM    2  Oh  tfa     1      43.930  42.838  42.829  1.00  0.00           O
HETATM    3  Oo  tfa     1      42.014  43.738  43.531  1.00  0.00           O
HETATM    4  Ho  tfa     1      44.463  43.543  43.222  1.00  0.00           H
HETATM    5  Hc  tfa     1      42.008  42.039  42.484  1.00  0.00           H
CONECT    1    2    3    5                                            
CONECT    2    1    4                                                 
CONECT    3    1                                                      
CONECT    4    2                                                      
CONECT    5    1                                                      
MASTER        0    0    0    0    0    0    0    0    5    0    5    0
END
```

```
COMPND    UNNAMED
AUTHOR    GENERATED BY OPEN BABEL 2.3.2
HETATM    6 AR   LIG     2       1.472  80.636  12.825  1.00  0.00           Ar
MASTER        0    0    0    0    0    0    0    0    1    0    1    0
END
```

!!! note "Note"
    You need to have different residue names for QM and MM atoms, here "tfa"
    (trans-formic acid) and "LIG". This is demanded by CP2K.

You also need to put different identifiers to atoms at this point.
Here we have:
- `Oh` : hydroxyl group oxygen
- `Oo` : carbonyl group oxygen
- `Ho` : hydroxyl group hydrogen
- `Hc` : hydrogen connected to carbon


Next we need to decide initial simulation box size, which depends on number of
atoms in simulation. If we have 1000 argon atoms then good initial box size is
86 Å. To put the molecule in box we need extra tools. [Gromacs](http://www.gromacs.org)
in example has that kind of tools.

To to put the molecule into the box we use `gmx editconf` command
```
gmx editconf -f tfa.pdb -box 8.6 8.6 8.6 -o tfa-b86.pdb
```

Here we use 86x86x86 Å box, which is ok when using 1000-matrix atoms. But you can
adjust this, depending on how many matrix atoms you have.

Next we need to add argon atoms into the box. For this we use `gmx insert-molecules`
command
```
gmx insert-molecules -f tfa-b86.pdb -ci ar.pdb -nmol 1000 -o tfa-ar.pdb
```

And now we have the final geometry input.

## CP2K input file

The best way to make CP2K input file is to split the file to several parts and
using `@include`-commands to gather them to one file.

To do this we make
- MM-potential file
- QM-calculation file
- QMMM-boundary file
- CP2K file to gather


First we make the MM-potential file.
```
&MM
    &FORCEFIELD
      &CHARGE
         ATOM Ar
         CHARGE 0.0
      &END CHARGE
      &CHARGE
         ATOM C
         CHARGE 0.0
      &END CHARGE
      &CHARGE
         ATOM Oo
         CHARGE 0.0
      &END CHARGE
      &CHARGE
         ATOM Ho
         CHARGE 0.0
      &END CHARGE
      &CHARGE
         ATOM Hc
         CHARGE 0.0
      &END CHARGE
      &CHARGE
         ATOM Oh
         CHARGE 0.0
      &END CHARGE

      IGNORE_MISSING_CRITICAL_PARAMS .TRUE.
      &NONBONDED
        # Argon-argon potential from http://www.sklogwiki.org/SklogWiki/index.php/Argon
        &LENNARD-JONES
          ATOMS Ar Ar
          EPSILON [K_e] 125.7
          SIGMA [angstrom] 3.345
          RCUT [angstrom] 9.0
        &END LENNARD-JONES

        # trans Formic acid - argon
        # Just copy the potential terms from potential fit here
        &GENPOT
            atoms Ar C
            FUNCTION Cvi/(r^6) + Cviii/(r^8) + Cx/(r^10) +  Cxii/(r^12) + Cvii/(r^7) + Cix/(r^9) + Cxi/(r^11)
            VARIABLES r
            PARAMETERS Cvi Cviii Cx Cxii Cvii Cix Cxi
            VALUES -22540.021633788096  -5.243549409354186e6  -3.2406578590178587e7  1.515360096536201e8  551050.9077903178  2.266474955203762e7  -5.3132065936126545e7
            RCUT [angstrom] 9.0
        &END GENPOT
        &GENPOT
            atoms Ar Oh
            FUNCTION Cvi/(r^6) + Cviii/(r^8) + Cx/(r^10) +  Cxii/(r^12) + Cvii/(r^7) + Cix/(r^9) + Cxi/(r^11)
            VARIABLES r
            PARAMETERS Cvi Cviii Cx Cxii Cvii Cix Cxi
            VALUES 13739.083360114846  5.471838619459709e6  1.6957303994470203e8  3.7516840650039065e8  -416048.44688283757  -3.998370403083761e7  -3.898432560739321e8
            RCUT [angstrom] 9.0
        &END GENPOT
        &GENPOT
            atoms Ar Oo
            FUNCTION Cvi/(r^6) + Cviii/(r^8) + Cx/(r^10) +  Cxii/(r^12) + Cvii/(r^7) + Cix/(r^9) + Cxi/(r^11)
            VARIABLES r
            PARAMETERS Cvi Cviii Cx Cxii Cvii Cix Cxi
            VALUES 9793.326640804324  3.1394020151115586e6  7.627842607574251e7  1.3069576949556419e8  -268179.8831127547  -2.0305102118835907e7  -1.550294791017888e8
            RCUT [angstrom] 9.0
        &END GENPOT
        &GENPOT
            atoms Ar Ho
            FUNCTION Cvi/(r^6) + Cviii/(r^8) + Cx/(r^10) +  Cxii/(r^12) + Cvii/(r^7) + Cix/(r^9) + Cxi/(r^11)
            VARIABLES r
            PARAMETERS Cvi Cviii Cx Cxii Cvii Cix Cxi
            VALUES -2432.1617929808244  -633286.4451121971  -1.042711058845794e7  -1.070334816166878e7  60921.18782589104  3.4584354851854523e6  1.6481702154332923e7
            RCUT [angstrom] 9.0
        &END GENPOT
        &GENPOT
            atoms Ar Hc
            FUNCTION Cvi/(r^6) + Cviii/(r^8) + Cx/(r^10) +  Cxii/(r^12) + Cvii/(r^7) + Cix/(r^9) + Cxi/(r^11)
            VARIABLES r
            PARAMETERS Cvi Cviii Cx Cxii Cvii Cix Cxi
            VALUES 4525.254249630937  858980.4449115618  7.2762912659367565e6  -3.2064841129619866e6  -99340.84352925561  -3.6312235927495877e6  -4.349257632528463e6
            RCUT [angstrom] 9.0
        &END GENPOT

      &END NONBONDED

    &END FORCEFIELD
    &POISSON
      PERIODIC XYZ
      # CP2K needs ewald summation section in input. But for us it is useless,
      # and you can put whatever values here.
      &EWALD
        EWALD_TYPE spme
        ALPHA .44
        GMAX  40
      &END EWALD
    &END POISSON

  &END MM
```

Then we make a QM-file with semi-empirical calculation method to condense the system.
Here we use AM1-method that is fine for formic acid.

```
&DFT
    BASIS_SET_FILE_NAME ${LIBDIR}/BASIS_MOLOPT
    POTENTIAL_FILE_NAME ${LIBDIR}/POTENTIAL
    &MGRID
      NGRIDS 4
      CUTOFF 350
      REL_CUTOFF 50
    &END MGRID

    &QS
       # We use semi-empirical to condence the system
       METHOD AM1
       &SE
         &COULOMB
           CUTOFF [angstrom] 10.0
         &END
         &EXCHANGE
           CUTOFF [angstrom] 10.0
         &END
      &END
    &END

    &SCF
      SCF_GUESS ATOMIC
      EPS_SCF 1.0E-6         # convergence threshold for total energy
      MAX_SCF 30
      &OUTER_SCF
        MAX_SCF 10
        EPS_SCF 1.0E-6
      &END
    &END SCF

    # Our QM-box is non periodic, so we need a Poison-solver
    &POISSON
      POISSON_SOLVER MT
      PERIODIC NONE
    &END POISSON

&END DFT

```

and a second file for DFT.
We use BLYP-D3BJ here.

```
&DFT
    BASIS_SET_FILE_NAME ${LIBDIR}/BASIS_MOLOPT
    POTENTIAL_FILE_NAME ${LIBDIR}/POTENTIAL
    &MGRID
      NGRIDS 4
      CUTOFF 350
      REL_CUTOFF 50
    &END MGRID

    &QS
       METHOD GPW
       EPS_DEFAULT 1.0E-10
       EXTRAPOLATION ASPC
    &END


    &SCF
      SCF_GUESS ATOMIC
      EPS_SCF 1.0E-6         # convergence threshold for total energy
      MAX_SCF 30
      &OUTER_SCF
        MAX_SCF 10
        EPS_SCF 1.0E-6
      &END
    &END SCF

    &XC
      &XC_FUNCTIONAL BLYP
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
         POTENTIAL_TYPE PAIR_POTENTIAL
         &PAIR_POTENTIAL
            TYPE DFTD3(BJ)
            R_CUTOFF 16
            REFERENCE_FUNCTIONAL BLYP
            PARAMETER_FILE_NAME ${LIBDIR}/dftd3.dat
         &END
      &END
    &END XC

    &POISSON
      POISSON_SOLVER MT
      PERIODIC NONE
    &END POISSON

&END DFT
```

Then we need to make the QM-MM file

```
&QMMM
    CENTER_GRID TRUE

    # For formic acid 10Å box is enough
    &CELL                    
      ABC [angstrom] 10 10 10
      PERIODIC NONE
    &END CELL

    # Define QM atoms
    &QM_KIND C
      MM_INDEX 1
    &END QM_KIND
    &QM_KIND O
      MM_INDEX 2 3
    &END QM_KIND
    &QM_KIND H
      MM_INDEX 4 5
    &END QM_KIND

    # Apply periodic potential for MM system (default)
    &PERIODIC
      # We can turn multipole off, because argon has no partial charge
      &MULTIPOLE OFF   
      &END
    &END PERIODIC

&END QMMM
```

!!! note "Note"
    `CENTER_GRID TRUE` is very important option. Without it QM system will heat
    up on its own and calculations will fail.


Finally we make a file that gathers all the other files. The idea here is that
you only need to edit this file in the future.

```
@SET SYSTEM equilib
@SET LIBDIR #add path to cp2k-data directory

&GLOBAL
  PROJECT ${SYSTEM}
  PRINT_LEVEL LOW
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  STRESS_TENSOR ANALYTICAL
  METHOD QMMM

  # These are the files we created previously
  @include qm-am1.inc
  @include mm.inc
  @include qmmm.inc

  &SUBSYS
    &CELL
      # box containing the system,
      # using 86x86x86 box we made earlier for the inputs
      ABC [angstrom] 86 86 86
    &END CELL
    &TOPOLOGY
      COORD_FILE_NAME tfa-ar.pdb
      COORD_FILE_FORMAT PDB
      CONN_FILE_FORMAT USER
      &GENERATE
         &ISOLATED_ATOMS
            # This need to span to all atoms in the simulation
            # We don't have any unbreakable mm-bonds in simulation
            LIST 1..1005
         &END
      &END
    &END TOPOLOGY
    &KIND Ho
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q1
      ELEMENT H
    &END KIND
    &KIND H                  
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q1
      ELEMENT H
    &END KIND
    &KIND Hc                 
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q1
      ELEMENT H
    &END KIND
    &KIND Oh
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q6
      ELEMENT O
    &END KIND
    &KIND Oo
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q6
      ELEMENT O
    &END KIND
    &KIND O
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q6
      ELEMENT O
    &END KIND
    &KIND C
      BASIS_SET TZVP-MOLOPT-GTH
      POTENTIAL GTH-BLYP-q4
    &END KIND
  &END SUBSYS

&END FORCE_EVAL

&MOTION

    &MD
        ENSEMBLE NVT
        TEMPERATURE [K] 80
        TEMP_TOL 50
        TIMESTEP [fs] 0.5
        STEPS 20000
        &THERMOSTAT
            REGION MASSIVE
            TYPE CSVR
            &CSVR
              TIMECON [fs] 100
            &END CSVR
        &END THERMOSTAT
    &END MD

    &PRINT
        &TRAJECTORY
            &EACH
                MD 20
            &END EACH
            FORMAT PDB
        &END TRAJECTORY
        &RESTART_HISTORY
            &EACH
                MD 5000
            &END EACH
        &END RESTART_HISTORY
    &END PRINT

&END MOTION

```

# Molecular dynamics

Overview here is to start from gas phase and have the system to condense to
solid matrix. To do this the simulation consist of 4 phases.

- Equilibration from initial coordinates to some kind of gas.
- Condensing gas solid.
- Changing calculation method from semi-empirical to DFT and equilibrate it.
- Calculate the spectrum.

### The first equilibration

Aim here is to create a super cooled gas that will compress to solid/liquid in
the next phase. To do this we need to set simulation temperature to lower than
boiling point. For argon 80 K is a good temperature. This can be done with the
input file that was constructed earlier.

### Condensing

To condense the system we need to change the dynamics to NTP, so that the external
pressure will compress it. To do it we'll use following input file

```
@SET SYSTEM condence
@SET LIBDIR # add path to cp2k-data directory

&GLOBAL
  PROJECT ${SYSTEM}
  PRINT_LEVEL LOW
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  STRESS_TENSOR ANALYTICAL
  METHOD QMMM


  @include qm-am1.inc
  @include mm.inc
  @include qmmm.inc

  @include subsys.inc


&MOTION

    &MD
        ENSEMBLE NPT_I
        TEMPERATURE [K] 20
        TIMESTEP [fs] 0.5
        STEPS 200000
        &THERMOSTAT
            REGION MASSIVE
            TYPE CSVR
            &CSVR
              TIMECON [fs] 250
            &END CSVR
        &END THERMOSTAT
        &BAROSTAT
             PRESSURE [bar] 1.0
             TEMPERATURE [K] 20
             TEMP_TOL [K] 20
             TIMECON [fs] 250
        &END BAROSTAT
    &END MD

    &PRINT
        &TRAJECTORY
            &EACH
                MD 40
            &END EACH
            FORMAT PDB
        &END TRAJECTORY
        &RESTART_HISTORY
            &EACH
                MD 50000
            &END EACH
        &END RESTART_HISTORY
    &END PRINT

&END MOTION
```

!!! note "Note"
    The rate at which the system condenses is heavily affected by thermostats
    coupling constant, here 250 fs. The system will condense slower, if the
    constant is smaller. 250 fs has proven to be a good value for many different
    systems.

This input file has additional file `subsys.inc` that includes `&SUBSYSTEM`
section form the previous run. You can get the section by using `grep` on restart
file.

```
grep -A 10000 "&SUBSYS"
```

In this phase we also set the final temperature, now 20 K.

### Change to DFT

Next we'll change QM calculation method to DFT. To do this we'll use slightly
modified input file from the previous phase

```
@SET SYSTEM dftequilib
@SET LIBDIR # add path to cp2k-data directory

&GLOBAL
  PROJECT ${SYSTEM}
  PRINT_LEVEL LOW
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  STRESS_TENSOR ANALYTICAL
  METHOD QMMM


  @include qm-blyp-d3bj.inc
  @include mm.inc
  @include qmmm.inc

  @include condensed_subsys.inc


&MOTION

    &MD
        ENSEMBLE NPT_I
        TEMPERATURE [K] 20
        TIMESTEP [fs] 0.5

        # You can increase this if needed
        STEPS 10000
        &THERMOSTAT
            REGION MASSIVE
            TYPE CSVR
            &CSVR
              # This constant is not that important anymore
              TIMECON [fs] 25
            &END CSVR
        &END THERMOSTAT
        &BAROSTAT
             PRESSURE [bar] 1.0
             TEMPERATURE [K] 20
             TEMP_TOL [K] 20
             TIMECON [fs] 250
        &END BAROSTAT
    &END MD

    &PRINT
        &TRAJECTORY
            &EACH
                MD 40
            &END EACH
            FORMAT PDB
        &END TRAJECTORY
        &RESTART_HISTORY
            &EACH
                MD 5000
            &END EACH
        &END RESTART_HISTORY
    &END PRINT

&END MOTION
```

## IR spectrum calculation

To calculate spectrum we need dipole moments, to do this we need to add command
to print them to our QM-file

```
&DFT
    BASIS_SET_FILE_NAME ${LIBDIR}/BASIS_MOLOPT
    POTENTIAL_FILE_NAME ${LIBDIR}/POTENTIAL
    &MGRID
      NGRIDS 4
      CUTOFF 350
      REL_CUTOFF 50
    &END MGRID

    &QS
       METHOD GPW
       EPS_DEFAULT 1.0E-10
       EXTRAPOLATION ASPC
    &END


    &SCF
      SCF_GUESS ATOMIC
      EPS_SCF 1.0E-6         # convergence threshold for total energy
      MAX_SCF 30
      &OUTER_SCF
        MAX_SCF 10
        EPS_SCF 1.0E-6
      &END
    &END SCF

    &XC
      &XC_FUNCTIONAL BLYP
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
         POTENTIAL_TYPE PAIR_POTENTIAL
         &PAIR_POTENTIAL
            TYPE DFTD3(BJ)
            R_CUTOFF 16
            REFERENCE_FUNCTIONAL BLYP
            PARAMETER_FILE_NAME ${LIBDIR}/dftd3.dat
         &END
      &END
    &END XC

    &POISSON
      POISSON_SOLVER MT
      PERIODIC NONE
    &END POISSON

    &PRINT
      &MOMENTS
       PERIODIC FALSE
       &EACH
         MD 1
       &END
       MAX_MOMENT 1
       FILENAME =dipole.traj
      &END MOMENTS
     &END

&END DFT
```


We'll also need to edit input file to change the mode to NVE


```
@SET SYSTEM spectrum
@SET LIBDIR # add path to cp2k-data directory

&GLOBAL
  PROJECT ${SYSTEM}
  PRINT_LEVEL LOW
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  STRESS_TENSOR ANALYTICAL
  METHOD QMMM


  @include qm-blyp-d3bj-dipoles.inc
  @include mm.inc
  @include qmmm.inc

  @include dft_subsys.inc


&MOTION

    &MD
        ENSEMBLE NVE
        TIMESTEP [fs] 0.5
        STEPS 80000
    &END MD

    &PRINT
        &TRAJECTORY
            &EACH
                MD 5
            &END EACH
            FORMAT PDB
        &END TRAJECTORY
        &RESTART_HISTORY
            &EACH
                MD 5000
            &END EACH
        &END RESTART_HISTORY
    &END PRINT

&END MOTION
```

This will create `dipole.traj`-file that contains dipole moments.
You can use [IRSpectrum.jl](https://github.com/MatrixLabTools/IRSpectrum.jl)
to calculate IR-spectrum form the dipole trajectory file.
